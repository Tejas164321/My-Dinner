rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Checks if the user making the request is an admin for a given mess.
    function isAdmin(messId) {
      return request.auth.uid == messId && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // MESSES: Publicly readable, only writable by the admin who owns it.
    match /messes/{messId} {
      allow read: if true;
      allow write: if isAdmin(messId);
    }

    // USERS: Can only be read/written by the user themselves, or by their mess admin.
    match /users/{userId} {
      allow read, write: if request.auth.uid == userId 
                         || isAdmin(resource.data.messId);
    }
    
    // MENUS: Readable by anyone, only writable by an admin.
    match /menus/{menuId} {
        allow read: if true;
        allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // ANNOUNCEMENTS: Readable by anyone, only create/delete by the owning admin.
    match /announcements/{announcementId} {
        allow read: if true;
        allow create: if isAdmin(request.resource.data.messId);
        allow delete: if isAdmin(resource.data.messId);
    }

    // LEAVES: Students can manage their own leaves. Admins can read all leaves for their mess.
    match /leaves/{leaveId} {
        allow read, write: if request.auth.uid == resource.data.studentId;
        // Future implementation could allow admins to read all leaves for their mess.
    }
    
    // HOLIDAYS: Readable by all, writable only by admins.
    match /holidays/{holidayId} {
      allow read: if true;
      allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // PLAN CHANGE REQUESTS: Writable by students, readable/deletable by the relevant admin.
    match /planChangeRequests/{requestId} {
        allow create: if request.auth.uid == request.resource.data.studentUid;
        allow read, delete: if isAdmin(resource.data.messId);
    }
  }
}
